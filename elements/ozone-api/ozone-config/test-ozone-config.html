<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>ozone-manage-connection</title>

  <script src="../../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../bower_components/web-component-tester/browser.js"></script>

  <!-- Step 1: import the element to test -->
  <link rel="import" href="ozone-config.html">


</head>
<body>
<fake-ozone-config id="ozoneConfig"></fake-ozone-config>
<test-fixture id="basic">
  <template>
    <ozone-config id="moduleUnderTest"></ozone-config>
  </template>
</test-fixture>

<script>
  addEventListener('WebComponentsReady', function() {
  describe('ozone-config tests', function() {
    let configModule,
      element,
      afterFunctions = [],
      server,
      responseHeaders = {json: {'Content-Type': 'application/json'}};

    beforeEach((done) => {
      server = sinon.fakeServer.create();
      configModule = fixture('basic');
      flush(done);
    });
    afterEach(() => {
      afterFunctions.map((cleanup) => {
        cleanup()
      });
      afterFunctions = [];
    });

    it('should request ozone config file and expose config in configPromise', (done) => {
      // -- Configure mock server
      server.respondWith(
        'GET',
        "./conf.ozone.json",
        [
          200,
          responseHeaders.json,
          '{"ozoneApi": {"server": "https://alpha.flowr.cloud/","endpoint": "ozone/"}}'
        ]
      );
      // -- start test

      configModule.configPromise.then(function(config){
        expect(config).to.deep.equal({server: "https://alpha.flowr.cloud/",endpoint: "ozone/"});
      })
        .then(() => done())
        .catch((e) => {
          done(e)
        });
      server.respond(); //Flush server
    });

    it('should catch error in configPromise', (done) => {

      // -- Configure mock server
      server.respondWith(
        'GET',
        "./conf.ozone.json",
        [
          400,
          responseHeaders.json,
          ''
        ]
      );
      // -- start test
      configModule.configPromise.catch((event) => {
        assert.isDefined(event.detail.error);
        done()
      });
      server.respond(); //Flush server
    });
  });
  });
</script>

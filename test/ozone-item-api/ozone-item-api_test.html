<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>ozone-components-demo test</title>

    <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../bower_components/web-component-tester/browser.js"></script>
    <link rel="import" href="../../bower_components/polymer/polymer.html">

    <dom-module id="fake-ozone-config">
        <template>

        </template>
        <script>
            class FakeOzoneConfig extends Polymer.Element {
                static get is () { return 'fake-ozone-config'; }

                static get properties() {
                    return {
                        /**
                         * Ozone config value in a promise.
                         */
                        configPromise: {
                            type: Object,
                            readOnly: true
                        }
                    }
                }

                constructor() {
                    super();
                    this._setConfigPromise(this._createConfigPromise())
                }

                _createConfigPromise() {
                    return new Promise(function (resolve) {
                        let fakeConfig = {
                            "host": "/ozone",
                            "endPoints": {
                                "items": "/rest/v3/items",
                                "new_Collection": "/rest/v3/new_Collection",
                                "a_Collection": "/rest/v3/a_Collection"
                            }
                        };
                        resolve(fakeConfig);
                    })
                        .then((config) => {
                            const configReady = new CustomEvent('config-ready', {
                                bubbles: true,
                                composed: true,
                                detail: config,
                            });

                            this.dispatchEvent(configReady);
                            return config;
                        });
                }
            }
            window.customElements.define(FakeOzoneConfig.is, FakeOzoneConfig);
        </script>
    </dom-module>

    <link rel="import" href="../../src/ozone-item-api/ozone-item-api.html">
</head>
<body>
<fake-ozone-config id="ozoneConfig"></fake-ozone-config>
<test-fixture id="basic">
    <template>
        <ozone-item-api collection="a_Collection"></ozone-item-api>
    </template>
</test-fixture>


<script>
    addEventListener('WebComponentsReady', function() {
        describe('ozone-api-login tests', function () {

            let element,
                server,
                responseHeaders = {json: {'Content-Type': 'application/json'}};

            beforeEach((done) => {
                element = fixture('basic');
                server = sinon.fakeServer.create();
                flush(done); //make sure every components are ready
            });

            afterEach(() => {
                server.restore();
            });
            it('should create an item', (done) => {
                // -- Configure mock server
                const expectedResponse = {an: 'object', with: "attributes"};
                server.respondWith(
                    'POST',
                    "/ozone/rest/v3/a_Collection/",
                    [
                        200,
                        responseHeaders.json,
                        JSON.stringify(expectedResponse)
                    ]
                );

                // -- start test
                element.create({some: 'data', with: "attributes"})
                    .then((response) => {
                        expect(response).to.be.deep.equal(expectedResponse);
                        done();
                    });
                server.respond(); //Flush server
            });

            it('should getOne an item', (done) => {
                // -- Configure mock server
                const expectedResponse = {an: 'object', with: "attributes"};
                server.respondWith(
                    'GET',
                    "/ozone/rest/v3/a_Collection/an_id",
                    [
                        200,
                        responseHeaders.json,
                        JSON.stringify(expectedResponse)
                    ]
                );

                // -- start test
                element.getOne('an_id')
                    .then((response) => {
                        expect(response).to.be.deep.equal(expectedResponse);
                        done();
                    });
                server.respond(); //Flush server
            });

            it('should update an item', (done) => {
                // -- Configure mock server
                const expectedResponse = {an: 'object', with: "attributes"};
                server.respondWith(
                    'POST',
                    "/ozone/rest/v3/a_Collection/",
                    [
                        200,
                        responseHeaders.json,
                        JSON.stringify(expectedResponse)
                    ]
                );

                // -- start test
                element.update({some: 'data', with: "attributes"})
                    .then((response) => {
                        expect(response).to.be.deep.equal(expectedResponse);
                        done();
                    });
                server.respond(); //Flush server
            });

            it('should deleteOne an item', (done) => {
                // -- Configure mock server
                const expectedResponse = 'item_Deleted';
                server.respondWith(
                    'DELETE',
                    "/ozone/rest/v3/a_Collection/an_id",
                    [
                        200,
                        responseHeaders.json,
                        JSON.stringify(expectedResponse)
                    ]
                );

                // -- start test
                element.deleteOne('an_id')
                    .then((response) => {
                        expect(response).to.be.equal(expectedResponse);
                        done();
                    });
                server.respond(); //Flush server
            });

            it('should bulkDelete items', (done) => {
                // -- Configure mock server
                const expectedResponse = ['item_Deleted'];
                server.respondWith(
                    'POST',
                    "/ozone/rest/v3/a_Collection/bulkDelete",
                    [
                        200,
                        responseHeaders.json,
                        JSON.stringify(expectedResponse)
                    ]
                );

                // -- start test
                element.bulkDelete('an_id')
                    .then((response) => {
                        expect(response).to.be.deep.equal(expectedResponse);
                        done();
                    });
                server.respond(); //Flush server
            });

            it('should bulkGet items', (done) => {
                // -- Configure mock server
                const expectedResponse = [
                        {an: 'object', with: "attributes"},
                        {an: 'other_object', with: "attributes"}
                    ];
                server.respondWith(
                    'POST',
                    "/ozone/rest/v3/a_Collection/bulkGet",
                    [
                        200,
                        responseHeaders.json,
                        JSON.stringify(expectedResponse)
                    ]
                );

                // -- start test
                element.bulkGet(['an_id'])
                    .then((response) => {
                    let result = [];
                    for(i of response){
                        result.push(i);
                    }
                        expect(result.length).to.equal(expectedResponse.length);
                        expect(result).to.include(expectedResponse[0]);
                        expect(result).to.include(expectedResponse[1]);
                        done();
                    });
                server.respond(); //Flush server
            });

            it('should bulkSave items', (done) => {
                // -- Configure mock server
                const expectedResponse = [
                    {an: 'object', with: "attributes"},
                    {an: 'other_object', with: "attributes"}
                ];
                server.respondWith(
                    'POST',
                    "/ozone/rest/v3/a_Collection/bulkSave",
                    [
                        200,
                        responseHeaders.json,
                        JSON.stringify(expectedResponse)
                    ]
                );

                // -- start test
                element.bulkSave([{some: 'data', with: "attributes"}])
                    .then((response) => {
                        let result = [];
                        for(i of response){
                            result.push(i);
                        }
                        expect(result.length).to.equal(expectedResponse.length);
                        expect(result).to.include(expectedResponse[0]);
                        expect(result).to.include(expectedResponse[1]);
                        done();
                    });
                server.respond(); //Flush server
            });

            it('should change url on collection update', (done) => {
                element.set('collection', 'new_Collection');
                flush(()=>{

                    expect(element.serviceUrl).to.be.equal('/ozone/rest/v3/new_Collection');

                    done();
                });
            });
        });
    });
</script>


</body>
</html>

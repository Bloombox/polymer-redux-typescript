<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../ozone-api/behaviors/ozone-api-ajax-mixin.html">
<link rel="import" href="../../taktik-helper/taktik-search-api-mixin/taktik-search-api-mixin.html">

<!--


`ozone-api-search` is a module for Ozone content suggestion.

Example:

```html
<ozone-api-search></ozone-api-search>
```

@demo
-->
<dom-module id="ozone-api-search">
  <template>
    <iron-ajax
      id="ozoneAccess"
      url="[[_searchEndPoint]]"
      method="POST"
      body="[[_searchParam]]"
      content-type="application/json; charset=utf-8"
      withCredentials
      auto$="[[auto]]">

    </iron-ajax>
  </template>
  <script>
    class OzoneApiSearch extends TaktikSearchApiMixin(OzoneApiAjaxMixin(Polymer.Element)) {
      static get is () { return 'ozone-api-search'; }

      static get properties() {
        return {
          /**
           * If true, it will suggest result for a *suggest* function.
           *
           * In suggest mode, *searchResults* is an array of aggregations object (key, docCount).
           * Otherwise it is a list of search items
           */
          suggest: {
            type: Boolean,
            value: false
          },
          /**
           * Type of items search.
           * Default value search in all types
           */
          itemType: {
            type: String,
            value: 'item'
          },
          /**
           * Max size of searchResults list.
           */
          size: {
            type: Number,
            value: 10
          },
          _searchEndPoint: {
            type: String
          },
          _searchParam: {
            type: Object
          }
        };
      }

      ready (){
        super.ready();
        this.addEventListener("ozone-request-success", (e) => this._handle_response(e));
        getOzoneConfig().configPromise.then((e) => this.configReady(e));
      }

      static get observers() {
        return [
          'computeServiceUrl(config.endPoints.items)', // OzoneApiAjaxBehavior
          '_computeSearchEndPoint(serviceUrl, itemType)',
          '_computeSearchParam(searchString, suggest, size)'
        ];
      }
        /**
         * Submit ozone search query
         */
        requestSearch () {
          this.$.ozoneAccess.generateRequest();
        }

        _handle_response () {
          let response = this.$.ozoneAccess.lastResponse;
          if(response.hasOwnProperty('aggregations')){
              let result = response.aggregations[0].buckets;
            this._setSearchResults(result);
          } else {
            let result = response.results;
            this._setSearchResults(result);
          }
        }

        _computeSearchEndPoint (serviceUrl, itemType) {
          if (serviceUrl) {
            this.set('_searchEndPoint', `${serviceUrl}/${itemType}/search`);
          }
        }

        _computeSearchParam (searchString, suggest, size){
            searchString = searchString ? searchString : ''; // replace undefined by empty string
            let allTerms = searchString.split(' ');
            let lastTerm = allTerms[allTerms.length-1];

            let searchParam = {};

            if (suggest) {
              searchParam["aggregations"] = [{
                  "$type": "TermsAggregation",
                  "name": "suggest",
                  "field": "_quicksearch",
                  "order": "COUNT_DESC",
                  "size": size,
                  "includePattern": `${lastTerm}.*`
                }];
              searchParam["size"] = 0;
              searchParam["query"] = {
                "$type": "QueryStringQuery",
                "field": "_quicksearch",
                "queryString": `${searchString}*`
              };
            } else {
              searchParam["size"] = size;
              searchParam["query"] = {
                "$type": "QueryStringQuery",
                "field": "_quicksearch",
                "queryString": `${searchString}*`
              };
            }
            this.set('_searchParam', JSON.stringify(searchParam));
        }

      configReady() {
            // compute search param at least one time.
          this._computeSearchParam(this.searchString, this.suggest, this.size);
        }
      }
    window.customElements.define(OzoneApiSearch.is, OzoneApiSearch);
  </script>
</dom-module>

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../ozone-api-behaviors/ozone-api-ajax-mixin.html">

<!--


`ozone-api-authentication` is a facility to verify Ozone connection status.

Example:

```html
<ozone-api-login></ozone-api-login>
```



@demo
-->
<dom-module id="ozone-api-authentication">
  <template>
    <iron-ajax id="ozoneAccess"
               url="[[serviceUrl]]"
               content-type="application/json; charset=utf-8"
               withCredentials
    ></iron-ajax>
  </template>
  <script>
    class OzoneApiAuthentication extends OzoneApiAjaxMixin(Polymer.Element) {
      static get is () { return 'ozone-api-authentication'; }

      static get properties() {
        return {
          /**
           * Indicate the ozone connection status.
           * Possible value: `connected` | `disconnected` | `offline` | `server error`.
           */
          connectionStatus: {
            type: String,
            value: "disconnected",
            readOnly: true,
            notify: true
          },
          /**
           * When a number is set, the connection will be verify periodically.
           */
          refreshPeriod: {
            type: Number
          },
          _refreshHandler: {
            type: Object
          }
        };
      }

      ready() {
        super.ready();

        this.addEventListener("ozone-request-success", (e) => this._handle_response(e));
        this.addEventListener("ozone-request-error", (e) => this._handle_error(e));
        getOzoneConfig().configPromise.then((e) => this.configReady(e));
        document.addEventListener('ozone-verify-connection',(event)=>{
          this.checkConnectionStatus();
        });
      }

      configReady() {
        this.checkConnectionStatus();
        this._configureRefreshPeriod();
      }

      static get observers() {
        return [
          'computeServiceUrl(config.endPoints.session)',
          '_configureRefreshPeriod(refreshPeriod)',
        ];
      }

      /**
       * Verify is the connection connection status Ozone.
       * It will force the refresh of *connectionStatus*
       */
      checkConnectionStatus () {
        this.$.ozoneAccess.timeout = 1000;
        const request = this.$.ozoneAccess.generateRequest();

        request.xhr.addEventListener('timeout', this._catchTimeOut.bind(this));
      }

      _catchTimeOut () {
        this._setConnectionStatus('offline');
      }

      _emitStatusChange(){
        this.dispatchEvent(new CustomEvent('ozone-status-change',
          {bubbles: true, composed:true, detail: this.connectionStatus}));
      }

      _handle_response(event) {
        if (this.$.ozoneAccess.lastResponse && this.$.ozoneAccess.lastResponse.sessionId) {
          this._setConnectionStatus('connected');
        } else {
          this._setConnectionStatus('disconnected');
        }
        this._emitStatusChange();
      }

      _handle_error(event) {
        // Set message to display
        if (event.detail.status == 403) {
          this._setConnectionStatus('disconnected');
        }
        else {
          this._setConnectionStatus('server error');
        }
        this._emitStatusChange();
      }

      _configureRefreshPeriod () {
        if(this.refreshPeriod){
          if (this._refreshHandler){
            clearInterval(this._refreshHandler);
            this._refreshHandler = setInterval(this.checkConnectionStatus.bind(this), this.refreshPeriod);
          }
        }
      }
    }
    window.customElements.define(OzoneApiAuthentication.is, OzoneApiAuthentication);
  </script>
</dom-module>
<script>
 function ozoneAuthenticationStatusGenerator() {
      let ozoneAuthenticationStatus;

      return () => {
        if (!document.querySelector('#ozoneAuthenticationStatus')) {
            ozoneAuthenticationStatus = document.createElement('ozone-api-authentication');
          ozoneAuthenticationStatus.id = 'ozoneAuthenticationStatus';
            document.body.appendChild(ozoneAuthenticationStatus);
          }
        return document.querySelector('#ozoneAuthenticationStatus')
      }
  }
  let getOzoneAuthenticationStatus = ozoneAuthenticationStatusGenerator();
</script>

<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>ozone-api-logout</title>

  <script src="../../../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../../web-component-tester/browser.js"></script>
  <script src="../../../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="../../../../polymer/polymer.html">
  <link rel="import" href="../../../../iron-ajax/iron-ajax.html">

  <!-- Step 1: import the element to test -->
  <link rel="import" href="../ozone-config/fake-ozone-config.html">
  <link rel="import" href="../ozone-config/ozone-config.html">
  <link rel="import" href="ozone-api-ajax-mixin.html">


</head>
<body>

<dom-module id="test-ozone-api-ajax">
  <template>
    <iron-ajax id="ozoneAccess"
               url="[[serviceUrl]]"
    ></iron-ajax>
  </template>
</dom-module>

<fake-ozone-config id="ozoneConfig"></fake-ozone-config>
<test-fixture id="basic">
  <template>
    <test-ozone-api-ajax></test-ozone-api-ajax>
  </template>
</test-fixture>

<script>
    addEventListener('WebComponentsReady', function() {
        class TestOzoneApiAjax extends OzoneApiAjaxMixin(Polymer.Element) {
            static get is () { return 'test-ozone-api-ajax'; }

            static get observers() {
                return ['computeServiceUrl(config.endPoints.logout)'];
            }

            request () {
                this.$.ozoneAccess.generateRequest();
            }
        }
        window.customElements.define(TestOzoneApiAjax.is, TestOzoneApiAjax);
        describe('test-ozone-api-ajax', function () {

            //replace('ozone-config').with('fake-ozone-config');
            getOzoneConfig = () => new FakeOzoneConfig();

            let element,
                afterFunctions = [],
                server,
                responseHeaders = {json: {'Content-Type': 'application/json'}};


            beforeEach((done) => {
                element = fixture('basic');
                server = sinon.fakeServer.create();
                flush(done); //make sure every components are ready
            });


            afterEach(() => {
                server.restore();
                afterFunctions.map((cleanup) => {
                    cleanup()
                });
                afterFunctions = [];

            });

            it('should fire ozone-request-success server 200', (done) => {

                let eventToWatch = 'ozone-request-success';

                // -- Prepare expect function
                let expectToBeCall = () => {
                    done();
                };

                // -- Configure Listener
                afterFunctions.push(() => {
                    if (element.removeEventListener) {
                        element.removeEventListener(eventToWatch, expectToBeCall);
                    }
                });
                element.addEventListener(eventToWatch, expectToBeCall);

                // -- Configure mock server
                server.respondWith(
                    'GET',
                    "/ozone/rest/v3/authentication/logout",
                    [
                        200,
                        responseHeaders.json,
                        '{"message": ""}'
                    ]
                );

                // -- start test
                element.request();
                server.respond(); //Flush server
            });

            it('should fire ozone-request-error on server error', (done) => {

                let eventToWatch = 'ozone-request-error';

                // -- Prepare expect function
                let expectToBeCall = (event) => {
                    expect(event.detail).to.deep.equal({
                        status: 500,
                        statusText: "Internal Server Error"
                    });
                    done()
                };

                // -- Configure Listener
                afterFunctions.push(() => {
                    if (element.removeEventListener) {
                        element.removeEventListener(eventToWatch, expectToBeCall);
                    }
                });
                element.addEventListener(eventToWatch, expectToBeCall);

                // -- Configure mock server
                server.respondWith(
                    'GET',
                    "/ozone/rest/v3/authentication/logout",
                    [
                        500,
                        responseHeaders.json,
                        '{"message": "server error"}'
                    ]
                );

                // -- start test
                element.request();
                server.respond(); //Flush server
            });

            it('it should set serviceUrl on config change', (done) => {
                expect(element.serviceUrl).to.be.equal("/ozone/rest/v3/authentication/logout");

                element.set('config.endPoints.logout', '/an/other/url');
                flush(() => {
                    expect(element.serviceUrl).to.be.equal("/ozone/an/other/url");
                    done();
                });


            });

        });
    });
</script>

</body>
</html>
